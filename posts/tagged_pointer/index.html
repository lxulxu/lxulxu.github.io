<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><style type=text/css>body{font-family:monospace}</style><title>Tagged Pointer</title><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel=stylesheet><link rel=stylesheet href=/css/style.css></head><body><header>===================<br>== <a href=https://lxulxu.github.io/>lxulxu's blog</a> ==<br>===================<div style=float:right>Hello there</div><br><p><nav><a href=/><b>Start</b></a>.
<a href=/posts/><b>Posts</b></a>.
<a href=/categories/><b>Categories</b></a>.
<a href=/tags/><b>Tags</b></a>.
<a href=/about/><b>About</b></a>.</nav></p></header><main><article><h1>Tagged Pointer</h1><b><time>09.02.2026 00:00</time></b>
<a href=/tags/c++>c++</a>
<a href=/tags/eda>eda</a><div><p>Tagged Pointer是一个经典的时间优化技术,通过巧妙利用内存对齐特性，在零额外内存开销下避免堆分配。</p><h2 id=基础原理>基础原理</h2><p>为了防止未对齐访问,编译器会插入填充0以根据类型的对齐要求对齐值，分配内存对齐到8字节(在64位系统上是16字节)，指针地址以000结尾 。可以利用这些未使用的低位来指示这不是真实指针,然后将对象数据直接存储在这个"非指针"的剩余部分中,而不是单独的内存分配。</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1</span><span>Top                       		Bottom
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">2</span><span>▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮▮000 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">3</span><span>                             					^^^
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">4</span><span>                             				可用于存储标记
</span></span></code></pre></div><h2 id=简单实现存储小整数>简单实现:存储小整数</h2><p>以一个能将小整数直接编码进指针的系统为例:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#8ec07c>#include</span> <span style=color:#8ec07c;font-style:italic>&lt;stdint.h&gt;</span><span style=color:#8ec07c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#8ec07c>#include</span> <span style=color:#8ec07c;font-style:italic>&lt;stdbool.h&gt;</span><span style=color:#8ec07c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span><span style=color:#928374;font-style:italic>// 标记位定义
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span><span style=color:#8ec07c>#define TAG_MASK    0x7      </span><span style=color:#928374;font-style:italic>// 低3位掩码: 0b111
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span><span style=color:#8ec07c>#define TAG_INT     0x1      </span><span style=color:#928374;font-style:italic>// 整数标记: 0b001
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span><span style=color:#8ec07c>#define TAG_PTR     0x0      </span><span style=color:#928374;font-style:italic>// 指针标记: 0b000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span><span style=color:#928374;font-style:italic>// 类型判断
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>bool</span> <span style=color:#fabd2f>is_tagged_int</span>(<span style=color:#fabd2f>uintptr_t</span> value) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span>    <span style=color:#fe8019>return</span> (value <span style=color:#fe8019>&amp;</span> TAG_MASK) <span style=color:#fe8019>==</span> TAG_INT;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>bool</span> <span style=color:#fabd2f>is_pointer</span>(<span style=color:#fabd2f>uintptr_t</span> value) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span>    <span style=color:#fe8019>return</span> (value <span style=color:#fe8019>&amp;</span> TAG_MASK) <span style=color:#fe8019>==</span> TAG_PTR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span><span style=color:#928374;font-style:italic>// 整数编码:左移3位后设置标记
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">19</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>uintptr_t</span> <span style=color:#fabd2f>encode_int</span>(<span style=color:#fabd2f>int64_t</span> num) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">20</span><span>    <span style=color:#fe8019>return</span> (num <span style=color:#fe8019>&lt;&lt;</span> <span style=color:#d3869b>3</span>) <span style=color:#fe8019>|</span> TAG_INT;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">21</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">23</span><span><span style=color:#928374;font-style:italic>// 整数解码:去除标记后右移
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">24</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>int64_t</span> <span style=color:#fabd2f>decode_int</span>(<span style=color:#fabd2f>uintptr_t</span> tagged) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">25</span><span>    <span style=color:#fe8019>return</span> (<span style=color:#fabd2f>int64_t</span>)tagged <span style=color:#fe8019>&gt;&gt;</span> <span style=color:#d3869b>3</span>;  <span style=color:#928374;font-style:italic>// 算术右移保留符号
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">26</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">28</span><span><span style=color:#928374;font-style:italic>// 指针编码:确保低3位为0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">29</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>uintptr_t</span> <span style=color:#fabd2f>encode_ptr</span>(<span style=color:#fabd2f>void</span><span style=color:#fe8019>*</span> ptr) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">30</span><span>    <span style=color:#fabd2f>uintptr_t</span> addr <span style=color:#fe8019>=</span> (<span style=color:#fabd2f>uintptr_t</span>)ptr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">31</span><span>    <span style=color:#928374;font-style:italic>// 断言指针已对齐
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">32</span><span>    <span style=color:#fabd2f>assert</span>((addr <span style=color:#fe8019>&amp;</span> TAG_MASK) <span style=color:#fe8019>==</span> <span style=color:#d3869b>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">33</span><span>    <span style=color:#fe8019>return</span> addr <span style=color:#fe8019>|</span> TAG_PTR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">34</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">36</span><span><span style=color:#928374;font-style:italic>// 指针解码:清除标记位
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">37</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>void</span><span style=color:#fe8019>*</span> <span style=color:#fabd2f>decode_ptr</span>(<span style=color:#fabd2f>uintptr_t</span> tagged) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">38</span><span>    <span style=color:#fe8019>return</span> (<span style=color:#fabd2f>void</span><span style=color:#fe8019>*</span>)(tagged <span style=color:#fe8019>&amp;</span> <span style=color:#fe8019>~</span>TAG_MASK);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">39</span><span>}
</span></span></code></pre></div><p>使用示例</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#928374;font-style:italic>// 示例:实现简单的动态类型值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#fe8019>typedef</span> <span style=color:#fabd2f>uintptr_t</span> Value;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span><span style=color:#928374;font-style:italic>// 创建整数值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span>Value <span style=color:#fabd2f>create_number</span>(<span style=color:#fabd2f>int64_t</span> num) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span>    <span style=color:#928374;font-style:italic>// 小整数:直接编码
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span>    <span style=color:#fe8019>if</span> (num <span style=color:#fe8019>&gt;=</span> <span style=color:#fe8019>-</span>(<span style=color:#d3869b>1LL</span> <span style=color:#fe8019>&lt;&lt;</span> <span style=color:#d3869b>60</span>) <span style=color:#fe8019>&amp;&amp;</span> num <span style=color:#fe8019>&lt;</span> (<span style=color:#d3869b>1LL</span> <span style=color:#fe8019>&lt;&lt;</span> <span style=color:#d3869b>60</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>        <span style=color:#fe8019>return</span> <span style=color:#fabd2f>encode_int</span>(num);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span>    <span style=color:#928374;font-style:italic>// 大整数:堆分配
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span>    <span style=color:#fabd2f>int64_t</span><span style=color:#fe8019>*</span> heap_num <span style=color:#fe8019>=</span> <span style=color:#fabd2f>malloc</span>(<span style=color:#fe8019>sizeof</span>(<span style=color:#fabd2f>int64_t</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span>    <span style=color:#fe8019>*</span>heap_num <span style=color:#fe8019>=</span> num;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span>    <span style=color:#fe8019>return</span> <span style=color:#fabd2f>encode_ptr</span>(heap_num);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span><span style=color:#928374;font-style:italic>// 整数加法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span>Value <span style=color:#fabd2f>add_numbers</span>(Value a, Value b) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span>    <span style=color:#fabd2f>int64_t</span> a_val, b_val;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">19</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">20</span><span>    <span style=color:#928374;font-style:italic>// 提取值a
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">21</span><span>    <span style=color:#fe8019>if</span> (<span style=color:#fabd2f>is_tagged_int</span>(a)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">22</span><span>        a_val <span style=color:#fe8019>=</span> <span style=color:#fabd2f>decode_int</span>(a);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">23</span><span>    } <span style=color:#fe8019>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">24</span><span>        <span style=color:#fabd2f>int64_t</span><span style=color:#fe8019>*</span> ptr <span style=color:#fe8019>=</span> <span style=color:#fabd2f>decode_ptr</span>(a);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">25</span><span>        a_val <span style=color:#fe8019>=</span> <span style=color:#fe8019>*</span>ptr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">26</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">27</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">28</span><span>    <span style=color:#928374;font-style:italic>// 提取值b
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">29</span><span>    <span style=color:#fe8019>if</span> (<span style=color:#fabd2f>is_tagged_int</span>(b)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">30</span><span>        b_val <span style=color:#fe8019>=</span> <span style=color:#fabd2f>decode_int</span>(b);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">31</span><span>    } <span style=color:#fe8019>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">32</span><span>        <span style=color:#fabd2f>int64_t</span><span style=color:#fe8019>*</span> ptr <span style=color:#fe8019>=</span> <span style=color:#fabd2f>decode_ptr</span>(b);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">33</span><span>        b_val <span style=color:#fe8019>=</span> <span style=color:#fe8019>*</span>ptr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">34</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">35</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">36</span><span>    <span style=color:#fe8019>return</span> <span style=color:#fabd2f>create_number</span>(a_val <span style=color:#fe8019>+</span> b_val);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">37</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">39</span><span><span style=color:#928374;font-style:italic>// 使用示例
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">40</span><span><span style=color:#fabd2f>int</span> <span style=color:#fabd2f>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">41</span><span>    Value num1 <span style=color:#fe8019>=</span> <span style=color:#fabd2f>create_number</span>(<span style=color:#d3869b>42</span>);       <span style=color:#928374;font-style:italic>// Tagged pointer
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">42</span><span>    Value num2 <span style=color:#fe8019>=</span> <span style=color:#fabd2f>create_number</span>(<span style=color:#d3869b>58</span>);       <span style=color:#928374;font-style:italic>// Tagged pointer
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">43</span><span>    Value sum <span style=color:#fe8019>=</span> <span style=color:#fabd2f>add_numbers</span>(num1, num2);  <span style=color:#928374;font-style:italic>// 结果:100
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">44</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">45</span><span>    <span style=color:#fabd2f>printf</span>(<span style=color:#b8bb26>&#34;Result: %lld</span><span style=color:#b8bb26>\n</span><span style=color:#b8bb26>&#34;</span>, <span style=color:#fabd2f>decode_int</span>(sum));  <span style=color:#928374;font-style:italic>// 输出: 100
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">46</span><span>    <span style=color:#fe8019>return</span> <span style=color:#d3869b>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">47</span><span>}
</span></span></code></pre></div><h2 id=经典应用场景and-inverter-graph-aig>经典应用场景:And-Inverter Graph (AIG)</h2><p>AIG是由二输入AND门和反相器组成的多级逻辑网络,用于表示二进制顺序逻辑电路。在数字电路设计中,任何布尔逻辑都可以用AND和NOT门表示。如果不使用Tagged Pointer,AIG节点结构可能是这样:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#928374;font-style:italic>// 传统实现:每条边需要单独存储反相信息
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#fe8019>typedef</span> <span style=color:#fe8019>struct</span> AigEdge_ {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span>    AigNode <span style=color:#fe8019>*</span>node;           <span style=color:#928374;font-style:italic>// 8字节
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span>    <span style=color:#fabd2f>unsigned</span> <span style=color:#fabd2f>int</span> <span style=color:#fb4934>complement</span> : <span style=color:#d3869b>1</span>;  <span style=color:#928374;font-style:italic>// 反相标记
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span>} AigEdge;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span><span style=color:#fe8019>typedef</span> <span style=color:#fe8019>struct</span> AigNode_ {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>    <span style=color:#fabd2f>unsigned</span> <span style=color:#fabd2f>int</span> id;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span>    AigEdge <span style=color:#fe8019>*</span>fanin0;  <span style=color:#928374;font-style:italic>// 指向输入边0 (16字节对象)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span>    AigEdge <span style=color:#fe8019>*</span>fanin1;  <span style=color:#928374;font-style:italic>// 指向输入边1 (16字节对象)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span>} AigNode;
</span></span></code></pre></div><ul><li><p>每个AigEdge占用16字节(8字节指针 + 对齐填充)</p></li><li><p>每个AND门需要2个fanin,额外32字节仅用于存储边信息</p></li></ul><p>ABC项目是加州大学伯克利分校开发的开源逻辑综合与验证工具，在其核心数据结构AIG的实现中，节点对象<a href=https://github.com/berkeley-abc/abc/blob/master/src/aig/aig/aig.h>Aig_Obj_t</a>使用tagged pointer优化，利用最低1位存储complement(反相)标记。在大规模电路网表中，这种优化的收益是显著的。</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#fe8019>struct</span> Aig_Obj_t_ {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span>    <span style=color:#928374;font-style:italic>// ===== Tagged Fanin指针 =====
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span>    Aig_Obj_t <span style=color:#fe8019>*</span>pFanin0;    <span style=color:#928374;font-style:italic>// 输入端0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span>    Aig_Obj_t <span style=color:#fe8019>*</span>pFanin1;    <span style=color:#928374;font-style:italic>// 输入端1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span>    <span style=color:#fabd2f>unsigned</span> <span style=color:#fabd2f>int</span> <span style=color:#fb4934>Type</span>    :  <span style=color:#d3869b>3</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span>    <span style=color:#fabd2f>unsigned</span> <span style=color:#fabd2f>int</span> <span style=color:#fb4934>fPhase</span>  :  <span style=color:#d3869b>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>    <span style=color:#fabd2f>unsigned</span> <span style=color:#fabd2f>int</span> <span style=color:#fb4934>fMarkA</span>  :  <span style=color:#d3869b>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span>    <span style=color:#fabd2f>unsigned</span> <span style=color:#fabd2f>int</span> <span style=color:#fb4934>fMarkB</span>  :  <span style=color:#d3869b>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span>    <span style=color:#fabd2f>unsigned</span> <span style=color:#fabd2f>int</span> <span style=color:#fb4934>nRefs</span>   : <span style=color:#d3869b>26</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span>    <span style=color:#fabd2f>unsigned</span>     <span style=color:#fb4934>Level</span>   : <span style=color:#d3869b>24</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span>    <span style=color:#fabd2f>unsigned</span>     <span style=color:#fb4934>nCuts</span>   :  <span style=color:#d3869b>8</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span>    <span style=color:#fabd2f>int</span>          TravId;       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span>    <span style=color:#fabd2f>int</span>          Id;            
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span>    <span style=color:#fe8019>union</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">19</span><span>        <span style=color:#fabd2f>void</span> <span style=color:#fe8019>*</span>   pData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">20</span><span>        <span style=color:#fabd2f>int</span>      iData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">21</span><span>        <span style=color:#fabd2f>float</span>    dData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">22</span><span>    };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">23</span><span>};
</span></span></code></pre></div><p>核心Tagged Pointer操作:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#928374;font-style:italic>// 检查边是否为反相 (检查最低位)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#8ec07c>#define Aig_IsComplement(p)   \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span><span style=color:#8ec07c>    (((int)((ABC_PTRUINT_T)(p) &amp; 01)))
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span><span style=color:#928374;font-style:italic>// 获取真实节点指针 (清除最低位)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span><span style=color:#8ec07c>#define Aig_Regular(p)        \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span><span style=color:#8ec07c>    ((Aig_Obj_t *)((ABC_PTRUINT_T)(p) &amp; ~01))
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span><span style=color:#928374;font-style:italic>// 获取非反相版本
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span><span style=color:#8ec07c>#define Aig_Not(p)            \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span><span style=color:#8ec07c>    ((Aig_Obj_t *)((ABC_PTRUINT_T)(p) ^ 01))
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span><span style=color:#928374;font-style:italic>// 带条件的反相
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span><span style=color:#8ec07c>#define Aig_NotCond(p,c)      \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span><span style=color:#8ec07c>    ((Aig_Obj_t *)((ABC_PTRUINT_T)(p) ^ (c)))
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span><span style=color:#928374;font-style:italic>// ===== 读取fanin操作 =====
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">19</span><span><span style=color:#928374;font-style:italic>// 获取fanin0的真实节点指针
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">20</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> Aig_Obj_t<span style=color:#fe8019>*</span> <span style=color:#fabd2f>Aig_ObjFanin0</span>(Aig_Obj_t<span style=color:#fe8019>*</span> pObj) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">21</span><span>    <span style=color:#fe8019>return</span> <span style=color:#fabd2f>Aig_Regular</span>(pObj<span style=color:#fe8019>-&gt;</span>pFanin0);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">22</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">24</span><span><span style=color:#928374;font-style:italic>// 获取fanin1的真实节点指针  
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">25</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> Aig_Obj_t<span style=color:#fe8019>*</span> <span style=color:#fabd2f>Aig_ObjFanin1</span>(Aig_Obj_t<span style=color:#fe8019>*</span> pObj) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">26</span><span>    <span style=color:#fe8019>return</span> <span style=color:#fabd2f>Aig_Regular</span>(pObj<span style=color:#fe8019>-&gt;</span>pFanin1);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">27</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">29</span><span><span style=color:#928374;font-style:italic>// 检查fanin0是否反相
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">30</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>int</span> <span style=color:#fabd2f>Aig_ObjFaninC0</span>(Aig_Obj_t<span style=color:#fe8019>*</span> pObj) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">31</span><span>    <span style=color:#fe8019>return</span> <span style=color:#fabd2f>Aig_IsComplement</span>(pObj<span style=color:#fe8019>-&gt;</span>pFanin0);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">32</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">34</span><span><span style=color:#928374;font-style:italic>// 检查fanin1是否反相
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">35</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>int</span> <span style=color:#fabd2f>Aig_ObjFaninC1</span>(Aig_Obj_t<span style=color:#fe8019>*</span> pObj) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">36</span><span>    <span style=color:#fe8019>return</span> <span style=color:#fabd2f>Aig_IsComplement</span>(pObj<span style=color:#fe8019>-&gt;</span>pFanin1);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">37</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">39</span><span><span style=color:#928374;font-style:italic>// ===== 构造操作 =====
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">41</span><span><span style=color:#928374;font-style:italic>// 创建AND门 (根据条件设置反相标记)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">42</span><span>Aig_Obj_t<span style=color:#fe8019>*</span> <span style=color:#fabd2f>Aig_And</span>(Aig_Man_t<span style=color:#fe8019>*</span> p, 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">43</span><span>                    Aig_Obj_t<span style=color:#fe8019>*</span> p0,   <span style=color:#fe8019>//</span> <span style=color:#fabd2f>fanin0</span> (可能已tagged)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">44</span><span>                    Aig_Obj_t<span style=color:#fe8019>*</span> p1) { <span style=color:#928374;font-style:italic>// fanin1 (可能已tagged)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">45</span><span>    Aig_Obj_t<span style=color:#fe8019>*</span> pNode <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_TableLookup</span>(p, p0, p1);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">46</span><span>    <span style=color:#fe8019>if</span> (pNode) <span style=color:#fe8019>return</span> pNode;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">47</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">48</span><span>    <span style=color:#928374;font-style:italic>// 创建新节点
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">49</span><span>    pNode <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_ManCreateNode</span>(p);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">50</span><span>    pNode<span style=color:#fe8019>-&gt;</span>pFanin0 <span style=color:#fe8019>=</span> p0;  <span style=color:#928374;font-style:italic>// 直接存储tagged pointer
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">51</span><span>    pNode<span style=color:#fe8019>-&gt;</span>pFanin1 <span style=color:#fe8019>=</span> p1;  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">52</span><span>    pNode<span style=color:#fe8019>-&gt;</span>Type <span style=color:#fe8019>=</span> AIG_OBJ_AND;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">53</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">54</span><span>    <span style=color:#fe8019>return</span> pNode;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">55</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">56</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">57</span><span><span style=color:#928374;font-style:italic>// 创建反相边: NOT(p) = AND(p, 1) 的特殊表示
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">58</span><span>Aig_Obj_t<span style=color:#fe8019>*</span> <span style=color:#fabd2f>Aig_Not_Func</span>(Aig_Obj_t<span style=color:#fe8019>*</span> p) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">59</span><span>    <span style=color:#fe8019>return</span> <span style=color:#fabd2f>Aig_Not</span>(p);  <span style=color:#928374;font-style:italic>// 翻转最低位
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">60</span><span>}
</span></span></code></pre></div><p>实际使用示例</p><ul><li>构造简单逻辑电路</li></ul><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#928374;font-style:italic>// 构造电路: out = NOT(AND(a, NOT(b)))  即 a NAND b
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#fabd2f>void</span> <span style=color:#fabd2f>build_nand_circuit</span>(Aig_Man_t<span style=color:#fe8019>*</span> pMan) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span>    <span style=color:#928374;font-style:italic>// 创建输入端口
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span>    Aig_Obj_t<span style=color:#fe8019>*</span> pA <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_ObjCreateCi</span>(pMan);  <span style=color:#928374;font-style:italic>// 输入a
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span>    Aig_Obj_t<span style=color:#fe8019>*</span> pB <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_ObjCreateCi</span>(pMan);  <span style=color:#928374;font-style:italic>// 输入b
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span>    <span style=color:#928374;font-style:italic>// 创建 NOT(b) - 只是翻转指针的最低位!
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>    Aig_Obj_t<span style=color:#fe8019>*</span> pNotB <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_Not</span>(pB);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span>    <span style=color:#928374;font-style:italic>// 创建 AND(a, NOT(b))
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span>    Aig_Obj_t<span style=color:#fe8019>*</span> pAnd <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_And</span>(pMan, pA, pNotB);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span>    <span style=color:#928374;font-style:italic>// 创建 NOT(AND(...))
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span>    Aig_Obj_t<span style=color:#fe8019>*</span> pNand <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_Not</span>(pAnd);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span>    <span style=color:#928374;font-style:italic>// 创建输出端口
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span>    <span style=color:#fabd2f>Aig_ObjCreateCo</span>(pMan, pNand);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span>}
</span></span></code></pre></div><ul><li>遍历电路拓扑</li></ul><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#928374;font-style:italic>// 递归计算节点逻辑值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#fabd2f>int</span> <span style=color:#fabd2f>Aig_ObjEvaluate</span>(Aig_Obj_t<span style=color:#fe8019>*</span> pObj, <span style=color:#fabd2f>int</span><span style=color:#fe8019>*</span> pInputVals) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span>    <span style=color:#928374;font-style:italic>// 常量节点
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span>    <span style=color:#fe8019>if</span> (<span style=color:#fabd2f>Aig_ObjIsConst1</span>(pObj)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span>        <span style=color:#fe8019>return</span> <span style=color:#d3869b>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>    <span style=color:#928374;font-style:italic>// 输入节点
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span>    <span style=color:#fe8019>if</span> (<span style=color:#fabd2f>Aig_ObjIsCi</span>(pObj)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span>        <span style=color:#fe8019>return</span> pInputVals[<span style=color:#fabd2f>Aig_ObjCioId</span>(pObj)];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span>    <span style=color:#928374;font-style:italic>// AND节点:需要处理fanin的complement标记
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span>    <span style=color:#fabd2f>assert</span>(<span style=color:#fabd2f>Aig_ObjIsAnd</span>(pObj));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span>    <span style=color:#928374;font-style:italic>// 1. 获取真实的fanin节点指针
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span>    Aig_Obj_t<span style=color:#fe8019>*</span> pFanin0 <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_ObjFanin0</span>(pObj);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span>    Aig_Obj_t<span style=color:#fe8019>*</span> pFanin1 <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_ObjFanin1</span>(pObj);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">19</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">20</span><span>    <span style=color:#928374;font-style:italic>// 2. 递归计算fanin的值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">21</span><span>    <span style=color:#fabd2f>int</span> val0 <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_ObjEvaluate</span>(pFanin0, pInputVals);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">22</span><span>    <span style=color:#fabd2f>int</span> val1 <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Aig_ObjEvaluate</span>(pFanin1, pInputVals);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">23</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">24</span><span>    <span style=color:#928374;font-style:italic>// 3. 根据complement标记进行反相
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">25</span><span>    <span style=color:#fe8019>if</span> (<span style=color:#fabd2f>Aig_ObjFaninC0</span>(pObj)) val0 <span style=color:#fe8019>=</span> <span style=color:#fe8019>!</span>val0;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">26</span><span>    <span style=color:#fe8019>if</span> (<span style=color:#fabd2f>Aig_ObjFaninC1</span>(pObj)) val1 <span style=color:#fe8019>=</span> <span style=color:#fe8019>!</span>val1;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">27</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">28</span><span>    <span style=color:#928374;font-style:italic>// 4. 返回AND结果
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">29</span><span>    <span style=color:#fe8019>return</span> val0 <span style=color:#fe8019>&amp;</span> val1;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">30</span><span>}
</span></span></code></pre></div></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/posts/soo/>小对象优化</a></li><li><a href=/posts/tagged_pointer/>Tagged Pointer</a></li><li><a href=/posts/tv_time_calendar/>生成追剧日历</a></li><li><a href=/posts/y2026q1-media-summary/>Y2026Q1 影视音总结</a></li><li><a href=/posts/y2025q4-media-summary/>Y2025Q4 影视音总结</a></li></ul></div></div></aside><footer><p>&copy; 2026 <a href=https://lxulxu.github.io/><b>lxulxu's blog</b></a>.
<a href=https://github.com/lxulxu><b>Github</b></a>.
<a href=https://space.bilibili.com/7739434><b>Bilibili</b></a>.</p></footer></body></html>