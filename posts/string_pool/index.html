<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><style type=text/css>body{font-family:monospace}</style><title>字符串池化解析：以Yosys IdString为例</title><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel=stylesheet><link rel=stylesheet href=/css/style.css></head><body><header>===================<br>== <a href=https://lxulxu.github.io/>lxulxu's blog</a> ==<br>===================<div style=float:right>Hello there</div><br><p><nav><a href=/><b>Start</b></a>.
<a href=/posts/><b>Posts</b></a>.
<a href=/categories/><b>Categories</b></a>.
<a href=/tags/><b>Tags</b></a>.
<a href=/about/><b>About</b></a>.</nav></p></header><main><article><h1>字符串池化解析：以Yosys IdString为例</h1><b><time>13.02.2026 00:00</time></b>
<a href=/tags/c++>c++</a>
<a href=/tags/eda>eda</a><div><h2 id=问题背景>问题背景</h2><p>在C++中，两个内容相同的字符串<code>std::string</code>是不同的对象：</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1</span><span>std<span style=color:#fe8019>::</span>string s1 <span style=color:#fe8019>=</span> <span style=color:#b8bb26>&#34;clk&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">2</span><span>std<span style=color:#fe8019>::</span>string s2 <span style=color:#fe8019>=</span> <span style=color:#b8bb26>&#34;clk&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">3</span><span>s1 <span style=color:#fe8019>==</span> s2;  <span style=color:#928374;font-style:italic>// true，但O(n)逐字符比较
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">4</span><span><span style=color:#fe8019>&amp;</span>s1[<span style=color:#d3869b>0</span>] <span style=color:#fe8019>!=</span> <span style=color:#fe8019>&amp;</span>s2[<span style=color:#d3869b>0</span>];  <span style=color:#928374;font-style:italic>// 不同内存地址
</span></span></span></code></pre></div><ul><li>比较开销： O(n)逐字符比较</li><li>内存冗余： 相同字符串多份拷贝</li><li>哈希表性能： 重复计算哈希值</li><li>缓存不友好： 分散存储，cache miss</li></ul><h2 id=yosys-idstring的解决方案><a href=https://github.com/YosysHQ/yosys/blob/main/kernel/rtlil.h>Yosys IdString</a>的解决方案</h2><p>IdString本质上是一个int</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1</span><span><span style=color:#fe8019>struct</span> IdString {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">2</span><span>    <span style=color:#fabd2f>int</span> index_;  <span style=color:#928374;font-style:italic>// 4字节ID代表字符串的身份
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">3</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">4</span><span>    <span style=color:#928374;font-style:italic>// O(1)比较
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">5</span><span>    <span style=color:#fabd2f>bool</span> <span style=color:#fe8019>operator</span><span style=color:#fe8019>==</span>(<span style=color:#fe8019>const</span> IdString <span style=color:#fe8019>&amp;</span>rhs) <span style=color:#fe8019>const</span> { 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">6</span><span>        <span style=color:#fe8019>return</span> index_ <span style=color:#fe8019>==</span> rhs.index_; 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">8</span><span>};
</span></span></code></pre></div><h3 id=全局存储架构>全局存储架构</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#928374;font-style:italic>// 实际字符串存储
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span><span style=color:#fe8019>static</span> std<span style=color:#fe8019>::</span>vector<span style=color:#fe8019>&lt;</span><span style=color:#fabd2f>char</span><span style=color:#fe8019>*&gt;</span> global_id_storage_;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span><span style=color:#928374;font-style:italic>// 索引 -&gt; 字符串指针
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span><span style=color:#928374;font-style:italic>// [0] -&gt; &#34;&#34; 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span><span style=color:#928374;font-style:italic>// [1] -&gt; &#34;$auto$1&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span><span style=color:#928374;font-style:italic>// [2] -&gt; &#34;\\clk&#34; 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span><span style=color:#928374;font-style:italic>// [3] -&gt; &#34;$and&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span><span style=color:#928374;font-style:italic>// 字符串到索引映射
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span><span style=color:#fe8019>static</span> dict<span style=color:#fe8019>&lt;</span><span style=color:#fabd2f>char</span><span style=color:#fe8019>*</span>, <span style=color:#fabd2f>int</span><span style=color:#fe8019>&gt;</span> global_id_index_;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span><span style=color:#928374;font-style:italic>// &#34;$auto$1&#34; -&gt; 1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span><span style=color:#928374;font-style:italic>// &#34;\\clk&#34;   -&gt; 2
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span><span style=color:#928374;font-style:italic>//引用计数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span><span style=color:#fe8019>static</span> std<span style=color:#fe8019>::</span>vector<span style=color:#fe8019>&lt;</span><span style=color:#fabd2f>int</span><span style=color:#fe8019>&gt;</span> global_refcount_storage_;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span><span style=color:#928374;font-style:italic>// [1] -&gt; 5   (5个地方引用&#34;$auto$1&#34;)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span><span style=color:#928374;font-style:italic>// [2] -&gt; 100 (100个地方引用&#34;clk&#34;)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">20</span><span><span style=color:#928374;font-style:italic>//空闲索引复用
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">21</span><span><span style=color:#fe8019>static</span> std<span style=color:#fe8019>::</span>vector<span style=color:#fe8019>&lt;</span><span style=color:#fabd2f>int</span><span style=color:#fe8019>&gt;</span> global_free_idx_list_;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">22</span><span><span style=color:#928374;font-style:italic>// [42, 57, 83]  // 这些索引可以复用
</span></span></span></code></pre></div><h3 id=string-interning>String Interning</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#fe8019>static</span> <span style=color:#fabd2f>int</span> <span style=color:#fabd2f>get_reference</span>(<span style=color:#fe8019>const</span> <span style=color:#fabd2f>char</span> <span style=color:#fe8019>*</span>p)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span>    log_assert(destruct_guard_ok);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span>    <span style=color:#fe8019>if</span> (<span style=color:#fe8019>!</span>p[<span style=color:#d3869b>0</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span>        <span style=color:#fe8019>return</span> <span style=color:#d3869b>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>    <span style=color:#928374;font-style:italic>// 查找是否已存在
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span>    <span style=color:#fe8019>auto</span> it <span style=color:#fe8019>=</span> global_id_index_.find((<span style=color:#fabd2f>char</span><span style=color:#fe8019>*</span>)p);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span>    <span style=color:#fe8019>if</span> (it <span style=color:#fe8019>!=</span> global_id_index_.end()) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span>        <span style=color:#928374;font-style:italic>// 已存在：增加引用计数，返回索引
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span>        global_refcount_storage_.at(it<span style=color:#fe8019>-&gt;</span>second)<span style=color:#fe8019>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span>        <span style=color:#fe8019>return</span> it<span style=color:#fe8019>-&gt;</span>second;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span>    log_assert(p[<span style=color:#d3869b>0</span>] <span style=color:#fe8019>==</span> <span style=color:#b8bb26>&#39;$&#39;</span> <span style=color:#fe8019>||</span> p[<span style=color:#d3869b>0</span>] <span style=color:#fe8019>==</span> <span style=color:#b8bb26>&#39;\\&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span>    log_assert(p[<span style=color:#d3869b>1</span>] <span style=color:#fe8019>!=</span> <span style=color:#d3869b>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span>    <span style=color:#fe8019>for</span> (<span style=color:#fe8019>const</span> <span style=color:#fabd2f>char</span> <span style=color:#fe8019>*</span>c <span style=color:#fe8019>=</span> p; <span style=color:#fe8019>*</span>c; c<span style=color:#fe8019>++</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">19</span><span>        <span style=color:#fe8019>if</span> ((<span style=color:#fabd2f>unsigned</span>)<span style=color:#fe8019>*</span>c <span style=color:#fe8019>&lt;=</span> (<span style=color:#fabd2f>unsigned</span>)<span style=color:#b8bb26>&#39; &#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">20</span><span>            log_error(<span style=color:#b8bb26>&#34;Found control character or space (0x%02x) in string &#39;%s&#39;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">21</span><span>                      <span style=color:#b8bb26>&#34; which is not allowed in RTLIL identifiers</span><span style=color:#b8bb26>\n</span><span style=color:#b8bb26>&#34;</span>, <span style=color:#fe8019>*</span>c, p);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">23</span><span>    <span style=color:#928374;font-style:italic>//分配新索引
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">24</span><span>    <span style=color:#fabd2f>int</span> idx;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">25</span><span>    <span style=color:#fe8019>if</span> (global_free_idx_list_.empty()) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">26</span><span>        <span style=color:#928374;font-style:italic>// 无空闲索引：扩容
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">27</span><span>        idx <span style=color:#fe8019>=</span> global_id_storage_.size();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">28</span><span>        global_id_storage_.push_back(<span style=color:#fe8019>nullptr</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">29</span><span>        global_refcount_storage_.push_back(<span style=color:#d3869b>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">30</span><span>    } <span style=color:#fe8019>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">31</span><span>        <span style=color:#928374;font-style:italic>// 复用空闲索引
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">32</span><span>        idx <span style=color:#fe8019>=</span> global_free_idx_list_.back();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">33</span><span>        global_free_idx_list_.pop_back();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">34</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">36</span><span>    <span style=color:#928374;font-style:italic>// 存储字符串
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">37</span><span>    global_id_storage_.at(idx) <span style=color:#fe8019>=</span> strdup(p);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">38</span><span>    global_id_index_[global_id_storage_.at(idx)] <span style=color:#fe8019>=</span> idx;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">39</span><span>    global_refcount_storage_.at(idx) <span style=color:#fe8019>=</span> <span style=color:#d3869b>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">41</span><span>    <span style=color:#fe8019>return</span> idx;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">42</span><span>}
</span></span></code></pre></div><h3 id=引用计数生命周期管理>引用计数生命周期管理</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#928374;font-style:italic>// 获取引用
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>int</span> <span style=color:#fabd2f>get_reference</span>(<span style=color:#fabd2f>int</span> idx)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span>    <span style=color:#fe8019>if</span> (idx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span>        global_refcount_storage_[idx]<span style=color:#fe8019>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span>    <span style=color:#fe8019>return</span> idx;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span><span style=color:#928374;font-style:italic>// 释放引用
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>void</span> <span style=color:#fabd2f>put_reference</span>(<span style=color:#fabd2f>int</span> idx)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span>    <span style=color:#fe8019>if</span> (<span style=color:#fe8019>!</span>destruct_guard_ok <span style=color:#fe8019>||</span> <span style=color:#fe8019>!</span>idx)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span>        <span style=color:#fe8019>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span>    <span style=color:#fabd2f>int</span> <span style=color:#fe8019>&amp;</span>refcount <span style=color:#fe8019>=</span> global_refcount_storage_[idx];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span>    <span style=color:#fe8019>if</span> (<span style=color:#fe8019>--</span>refcount <span style=color:#fe8019>&gt;</span> <span style=color:#d3869b>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">19</span><span>        <span style=color:#fe8019>return</span>;  <span style=color:#928374;font-style:italic>// 还有引用，不释放
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">21</span><span>    <span style=color:#928374;font-style:italic>// 引用归零：释放字符串，回收索引
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">22</span><span>    log_assert(refcount <span style=color:#fe8019>==</span> <span style=color:#d3869b>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">23</span><span>    free_reference(idx);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">24</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">26</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>inline</span> <span style=color:#fabd2f>void</span> <span style=color:#fabd2f>free_reference</span>(<span style=color:#fabd2f>int</span> idx)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">27</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">28</span><span>    <span style=color:#928374;font-style:italic>// 从哈希表移除
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">29</span><span>    global_id_index_.erase(global_id_storage_.at(idx));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">30</span><span>    <span style=color:#928374;font-style:italic>// 释放C字符串
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">31</span><span>    free(global_id_storage_.at(idx));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">32</span><span>    global_id_storage_.at(idx) <span style=color:#fe8019>=</span> <span style=color:#fe8019>nullptr</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">33</span><span>    <span style=color:#928374;font-style:italic>// 索引加入空闲列表
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">34</span><span>    global_free_idx_list_.push_back(idx);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">35</span><span>}
</span></span></code></pre></div><h3 id=析构保护机制>析构保护机制</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1</span><span><span style=color:#928374;font-style:italic>// 防止静态析构顺序问题
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">2</span><span><span style=color:#fe8019>static</span> <span style=color:#fabd2f>bool</span> destruct_guard_ok;  <span style=color:#928374;font-style:italic>// POD，初始化为false
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">4</span><span><span style=color:#fe8019>static</span> <span style=color:#fe8019>struct</span> destruct_guard_t {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">5</span><span>    destruct_guard_t() { destruct_guard_ok <span style=color:#fe8019>=</span> <span style=color:#fabd2f>true</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">6</span><span>    <span style=color:#fe8019>~</span>destruct_guard_t() { destruct_guard_ok <span style=color:#fe8019>=</span> <span style=color:#fabd2f>false</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">7</span><span>} destruct_guard;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1</span><span><span style=color:#928374;font-style:italic>// 问题场景：全局IdString在静态析构时
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">2</span><span><span style=color:#fe8019>static</span> IdString <span style=color:#fabd2f>g_clk</span>(<span style=color:#b8bb26>&#34;</span><span style=color:#b8bb26>\\</span><span style=color:#b8bb26>clk&#34;</span>);  <span style=color:#928374;font-style:italic>// 全局对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">4</span><span><span style=color:#928374;font-style:italic>// main结束后析构顺序不确定：
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">5</span><span><span style=color:#928374;font-style:italic>// 如果global_refcount_storage_先析构，g_clk析构时访问已释放内存
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">6</span><span><span style=color:#928374;font-style:italic>// destruct_guard在global_refcount_storage_之后析构，保护机制生效
</span></span></span></code></pre></div><h3 id=sticky-ids优化>Sticky IDs优化</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#8ec07c>#ifdef YOSYS_USE_STICKY_IDS
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#fe8019>static</span> <span style=color:#fabd2f>int</span> last_created_idx_ptr_;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span><span style=color:#fe8019>static</span> <span style=color:#fabd2f>int</span> last_created_idx_[<span style=color:#d3869b>8</span>];  <span style=color:#928374;font-style:italic>// 环形缓冲区
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span><span style=color:#8ec07c>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span><span style=color:#928374;font-style:italic>// 在get_reference中：
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span><span style=color:#8ec07c>#ifdef YOSYS_USE_STICKY_IDS
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span><span style=color:#928374;font-style:italic>// 避免 Create-&gt;Delete-&gt;Create 模式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span><span style=color:#928374;font-style:italic>// 场景：临时IdString创建后立即销毁，然后再次创建相同字符串
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span><span style=color:#928374;font-style:italic>// 问题：索引被回收又分配，导致缓存失效
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">11</span><span><span style=color:#928374;font-style:italic>// 解决：保留最近创建的8个索引不回收
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">13</span><span><span style=color:#fe8019>if</span> (last_created_idx_[last_created_idx_ptr_])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">14</span><span>    put_reference(last_created_idx_[last_created_idx_ptr_]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">15</span><span>last_created_idx_[last_created_idx_ptr_] <span style=color:#fe8019>=</span> idx;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">16</span><span>get_reference(last_created_idx_[last_created_idx_ptr_]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">17</span><span>last_created_idx_ptr_ <span style=color:#fe8019>=</span> (last_created_idx_ptr_ <span style=color:#fe8019>+</span> <span style=color:#d3869b>1</span>) <span style=color:#fe8019>&amp;</span> <span style=color:#d3869b>7</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">18</span><span><span style=color:#8ec07c>#endif
</span></span></span></code></pre></div><h2 id=idstring-相比-stdstring-的优势>IdString 相比 std::string 的优势</h2><h3 id=性能比较>性能比较</h3><table><thead><tr><th style=text-align:left>场景</th><th style=text-align:left>IdString</th><th style=text-align:left>std::string</th></tr></thead><tbody><tr><td style=text-align:left>对象大小</td><td style=text-align:left>4 字节</td><td style=text-align:left>32 字节</td></tr><tr><td style=text-align:left>字符串存储</td><td style=text-align:left>全局唯一存储，无重复</td><td style=text-align:left>每个 string 独立管理或共享</td></tr><tr><td style=text-align:left>构造（已存在）</td><td style=text-align:left><strong>O(1)</strong> 哈希查找</td><td style=text-align:left>O(n) 拷贝</td></tr><tr><td style=text-align:left>比较</td><td style=text-align:left><strong>O(1)</strong> 整数比较</td><td style=text-align:left>O(n) 逐字符</td></tr><tr><td style=text-align:left>哈希</td><td style=text-align:left><strong>O(1)</strong> 预计算</td><td style=text-align:left>O(n) 实时计算</td></tr><tr><td style=text-align:left>拷贝</td><td style=text-align:left><strong>O(1)</strong> 整数拷贝</td><td style=text-align:left>O(n) 深拷贝或引用计数</td></tr><tr><td style=text-align:left>析构</td><td style=text-align:left><strong>O(1)</strong></td><td style=text-align:left>取决于实现</td></tr></tbody></table><h3 id=缓存局部性>缓存局部性</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">1</span><span><span style=color:#928374;font-style:italic>// IdString：索引访问连续内存，缓存友好
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">2</span><span><span style=color:#fe8019>for</span> (<span style=color:#fe8019>auto</span> <span style=color:#fb4934>id</span> : id_list) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">3</span><span>    <span style=color:#fe8019>const</span> <span style=color:#fabd2f>char</span><span style=color:#fe8019>*</span> str <span style=color:#fe8019>=</span> global_id_storage_[id.index_];  <span style=color:#928374;font-style:italic>// 顺序访问
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">6</span><span><span style=color:#928374;font-style:italic>// std::string：指针跳跃，缓存不友好
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">7</span><span><span style=color:#fe8019>for</span> (<span style=color:#fe8019>const</span> <span style=color:#fe8019>auto</span><span style=color:#fe8019>&amp;</span> <span style=color:#fb4934>s</span> : string_list) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">8</span><span>    <span style=color:#928374;font-style:italic>// s.data() 指向堆上随机位置
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">9</span><span>}
</span></span></code></pre></div><h2 id=底层用-char-而非-stdstring的优势>底层用 <code>char*</code> 而非 <code>std::string</code>的优势</h2><p><code>char*</code> + <code>strdup</code> 实现隐式去重</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 1</span><span><span style=color:#fe8019>static</span> dict<span style=color:#fe8019>&lt;</span><span style=color:#fabd2f>char</span><span style=color:#fe8019>*</span>, <span style=color:#fabd2f>int</span><span style=color:#fe8019>&gt;</span> global_id_index_;  <span style=color:#928374;font-style:italic>// char* → 索引
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 2</span><span><span style=color:#fe8019>static</span> std<span style=color:#fe8019>::</span>vector<span style=color:#fe8019>&lt;</span><span style=color:#fabd2f>char</span><span style=color:#fe8019>*&gt;</span> global_id_storage_;  <span style=color:#928374;font-style:italic>// 存储
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 4</span><span><span style=color:#928374;font-style:italic>// 插入时
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 5</span><span><span style=color:#fabd2f>char</span><span style=color:#fe8019>*</span> dup <span style=color:#fe8019>=</span> strdup(str);  <span style=color:#928374;font-style:italic>// 新分配
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 6</span><span><span style=color:#fe8019>if</span> (global_id_index_.count(dup)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 7</span><span>    free(dup);  <span style=color:#928374;font-style:italic>// 已存在，释放重复
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 8</span><span>    <span style=color:#fe8019>return</span> existing_index;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#756d59">10</span><span><span style=color:#928374;font-style:italic>// 新字符串保留，地址唯一
</span></span></span></code></pre></div><p>利用 <code>strdup</code> 的堆分配特性——相同内容的字符串若已存在，其指针地址必然相同，哈希表可直接用指针比较替代字符串比较，达到 <strong>O(1)</strong> 的查找和比较性能。</p><table><thead><tr><th style=text-align:left>考量</th><th style=text-align:left><code>char*</code></th><th style=text-align:left><code>std::string</code></th></tr></thead><tbody><tr><td style=text-align:left><strong>内存开销</strong></td><td style=text-align:left>8 字节指针</td><td style=text-align:left>≥32 字节（SSO 除外）</td></tr><tr><td style=text-align:left><strong>哈希表键比较</strong></td><td style=text-align:left>指针直接比较（地址相同即相等）</td><td style=text-align:left>逐字符比较或自定义哈希</td></tr><tr><td style=text-align:left><strong>去重机制</strong></td><td style=text-align:left><code>strdup</code> 保证相同内容相同地址</td><td style=text-align:left>需额外处理</td></tr></tbody></table><h2 id=应用场景>应用场景</h2><h3 id=推荐场景>推荐场景</h3><ul><li><strong>字符串重复度高</strong>（如编译器符号表、电路信号名），池化可显著节省内存</li><li><strong>频繁进行比较或哈希操作</strong>，整数索引替代逐字符比较</li><li><strong>内存受限环境</strong>，用索引替换指针+长度+容量的冗余存储</li></ul><h3 id=不适用场景>不适用场景</h3><ul><li><strong>字符串基本唯一</strong>，池化引入额外开销却无去重收益</li><li><strong>比较操作极少</strong>，池化的查找成本无法摊平</li><li><strong>工具运行时间短</strong>，构造和销毁池的开销占比过高</li><li><strong>多线程高并发</strong>，全局池成为锁竞争热点，反而降低性能</li></ul></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/posts/string_pool/>字符串池化解析：以Yosys IdString为例</a></li><li><a href=/posts/soo/>小对象优化</a></li><li><a href=/posts/tagged_pointer/>Tagged Pointer</a></li><li><a href=/posts/tv_time_calendar/>生成追剧日历</a></li><li><a href=/posts/y2026q1-media-summary/>Y2026Q1 影视音总结</a></li></ul></div></div></aside><footer><p>&copy; 2026 <a href=https://lxulxu.github.io/><b>lxulxu's blog</b></a>.
<a href=https://github.com/lxulxu><b>Github</b></a>.
<a href=https://space.bilibili.com/7739434><b>Bilibili</b></a>.</p></footer></body></html>